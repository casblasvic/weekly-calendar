# üß† ENERGY INSIGHTS - SISTEMA INTELIGENTE DE AN√ÅLISIS DE ANOMAL√çAS

## üìã Resumen Ejecutivo

Sistema avanzado de detecci√≥n y an√°lisis de anomal√≠as energ√©ticas dise√±ado para optimizar el rendimiento de cl√≠nicas de belleza y preparado para integraci√≥n con agente IA. Implementa m√∫ltiples estrategias de an√°lisis, recomendaciones contextuales y metadatos completos para aprendizaje autom√°tico.

## üéØ Objetivos del Sistema

### Objetivos Principales
- **Detecci√≥n Inteligente**: Identificar anomal√≠as en consumo energ√©tico y duraci√≥n de tratamientos
- **An√°lisis Contextual**: Evaluar patrones de comportamiento de clientes y empleados
- **Recomendaciones Automatizadas**: Generar acciones espec√≠ficas basadas en contexto
- **Preparaci√≥n para IA**: Estructurar datos para futuro aprendizaje autom√°tico

### Objetivos Secundarios
- **Optimizaci√≥n Energ√©tica**: Reducir costos operativos
- **Detecci√≥n de Fraude**: Identificar comportamientos sospechosos
- **Mejora de Procesos**: Optimizar t√©cnicas y procedimientos
- **Gesti√≥n de Calidad**: Mantener est√°ndares de servicio

## üîß Arquitectura del Sistema

### Componentes Principales

#### 1. **Motor de C√°lculo Inteligente** (`lib/energy/calculate-expected-energy.ts`)
```typescript
interface ExpectedEnergyResult {
  // Datos b√°sicos
  expectedKwh: number
  stdDevSum: number
  confidence: 'high' | 'medium' | 'low' | 'insufficient_data'
  
  // ü§ñ Metadatos para IA
  calculationMethod: 'statistical_profile' | 'fallback_duration' | 'theoretical_estimate'
  fallbackUsed: boolean
  dataQuality: {
    minSamples: number
    avgSamples: number
    profileCoverage: number
    confidenceScore: number // 0-1 score para ML
  }
  contextMetadata: {
    servicesAnalyzed: ServiceAnalysis[]
    equipmentId: string
    timestamp: string
  }
}
```

#### 2. **Analizador de Patrones** (`app/api/internal/energy-insights/route.ts`)
```typescript
interface PatternAnalysis {
  clientPatterns: ClientPattern[]
  employeePatterns: EmployeePattern[]
  servicePatterns: ServicePattern[]
  temporalPatterns: TemporalPattern[]
  
  // ü§ñ Metadatos para IA
  aiAnalysisMetadata: {
    dataQuality: DataQualityMetrics
    trendsDetected: TrendAnalysis
    analysisTimestamp: string
  }
}
```

#### 3. **Sistema de Recomendaciones** (Funci√≥n `generateIntelligentRecommendations`)
```typescript
interface Recommendation {
  type: string
  priority: 'low' | 'medium' | 'high' | 'critical'
  category: string
  message: string
  actionRequired: boolean
  estimatedImpact: 'low' | 'medium' | 'high'
  
  // ü§ñ Metadatos para IA
  aiMetadata: {
    confidenceScore: number
    riskLevel: string
    recommendationType: string
    [key: string]: any // Datos contextuales espec√≠ficos
  }
}
```

## üìä Estrategias de C√°lculo

### 1. **An√°lisis Estad√≠stico** (Preferido)
- **Fuente**: Perfiles energ√©ticos hist√≥ricos (`ServiceEnergyProfile`)
- **Algoritmo**: Welford para media y desviaci√≥n est√°ndar
- **Validaci√≥n**: M√≠nimo 5 muestras por perfil
- **Confianza**: Alta (80%+ cobertura de servicios)

### 2. **Fallback Inteligente** (Autom√°tico)
- **Trigger**: Servicios sin perfil estad√≠stico v√°lido
- **L√≥gica**: `treatmentDurationMinutes || durationMinutes`
- **Estimaci√≥n**: 3.5 kWh/hora para equipos l√°ser
- **Confianza**: Media-Baja seg√∫n cobertura

### 3. **Estimaci√≥n Te√≥rica** (√öltimo recurso)
- **Trigger**: Sin datos hist√≥ricos ni configuraci√≥n
- **Valores**: Duraci√≥n 15min, 0.058 kWh/min
- **Confianza**: Baja (solo para continuidad operativa)

## üéØ Casos de An√°lisis Detallados

### Tabla de Casos de Detecci√≥n

| **Caso** | **Hist√≥rico Cliente** | **Hist√≥rico Empleado** | **Baseline Usado** | **Confianza** | **Acci√≥n IA** |
|----------|----------------------|----------------------|-------------------|---------------|---------------|
| **1A** | ‚ùå Primera vez | ‚úÖ Existe | Promedio servicio | Media | Monitorear patr√≥n inicial |
| **1B** | ‚úÖ Existe | ‚úÖ Existe | Hist√≥rico cliente | Alta | Comparar con patr√≥n personal |
| **1C** | ‚úÖ Existe | ‚ùå Nuevo empleado | Hist√≥rico cliente | Media | Entrenar empleado con datos cliente |
| **2A** | ‚ùå Primera vez | ‚úÖ Existe | Suma promedios | Media | Crear perfil combo |
| **2B** | ‚úÖ Combo exacto | ‚úÖ Existe | Hist√≥rico combo | Alta | Optimizar combo espec√≠fico |
| **2C** | ‚úÖ Servicios individuales | ‚úÖ Existe | Suma hist√≥ricos | Alta | Evaluar eficiencia combo |
| **3A** | ‚ùå Primera vez | ‚ùå Nuevo empleado | Configuraci√≥n servicio | Baja | Supervisi√≥n estrecha |
| **3B** | ‚ùå Primera vez | ‚ùå Nuevo empleado | Suma configuraciones | Baja | Entrenamiento intensivo |

## üß† Sistema de Recomendaciones

### Categor√≠as de Recomendaciones

#### 1. **Detecci√≥n de Fraude** (`fraud_detection`)
- **Trigger**: Desviaci√≥n >200% o patrones sospechosos
- **Acciones**: Investigaci√≥n inmediata, supervisi√≥n
- **IA**: Alta confianza, riesgo cr√≠tico

#### 2. **Mantenimiento T√©cnico** (`technical_issue`)
- **Trigger**: Sub-consumo, fallos de equipo
- **Acciones**: Verificaci√≥n, calibraci√≥n, reparaci√≥n
- **IA**: Alta confianza, impacto operativo

#### 3. **Gesti√≥n de Personal** (`human_resources`)
- **Trigger**: Patrones de eficiencia an√≥malos
- **Acciones**: Entrenamiento, reconocimiento
- **IA**: Media confianza, mejora gradual

#### 4. **Optimizaci√≥n Energ√©tica** (`energy_management`)
- **Trigger**: Sobre-consumo consistente
- **Acciones**: Ajuste de configuraci√≥n, t√©cnica
- **IA**: Media confianza, ahorro operativo

#### 5. **Mejora de Procesos** (`process_improvement`)
- **Trigger**: Duraciones an√≥malas
- **Acciones**: Revisi√≥n de procedimientos
- **IA**: Media confianza, eficiencia operativa

## ü§ñ Preparaci√≥n para Agente IA

### Estructura de Datos para ML

#### 1. **Features Principales**
```typescript
interface MLFeatures {
  // Datos num√©ricos
  deviationPct: number
  confidenceScore: number
  profileCoverage: number
  
  // Datos categ√≥ricos
  calculationMethod: string
  insightType: string
  severity: string
  
  // Contexto temporal
  hourOfDay: number
  dayOfWeek: number
  
  // Contexto de negocio
  clientRiskScore: number
  employeeEfficiency: number
  serviceComplexity: number
}
```

#### 2. **Labels para Entrenamiento**
```typescript
interface MLLabels {
  // Clasificaci√≥n de anomal√≠as
  anomalyType: string
  severityLevel: string
  
  // Resultados de acciones
  recommendationFollowed: boolean
  issueResolved: boolean
  timeToResolution: number
  
  // Impacto de negocio
  costImpact: number
  customerSatisfaction: number
  operationalEfficiency: number
}
```

#### 3. **Metadatos de Calidad**
```typescript
interface DataQualityMetrics {
  // Completitud de datos
  dataCompleteness: number
  profileAvailability: number
  
  // Calidad estad√≠stica
  sampleSize: number
  varianceStability: number
  
  // Contexto temporal
  dataFreshness: number
  seasonalAdjustment: number
}
```

### Estrategias de Aprendizaje

#### 1. **Aprendizaje Supervisado**
- **Objetivo**: Clasificar tipos de anomal√≠as
- **Features**: Desviaciones, patrones, contexto
- **Labels**: Tipos confirmados, resoluciones exitosas

#### 2. **Aprendizaje No Supervisado**
- **Objetivo**: Descubrir patrones ocultos
- **T√©cnicas**: Clustering, detecci√≥n de outliers
- **Aplicaci√≥n**: Nuevos tipos de anomal√≠as

#### 3. **Aprendizaje por Refuerzo**
- **Objetivo**: Optimizar recomendaciones
- **Recompensas**: Resoluci√≥n exitosa, satisfacci√≥n
- **Acciones**: Tipos de recomendaciones, prioridades

## üìà M√©tricas de Rendimiento

### KPIs Operativos
- **Tasa de Detecci√≥n**: % de anomal√≠as detectadas vs reales
- **Precisi√≥n**: % de anomal√≠as reales vs falsas alarmas
- **Tiempo de Resoluci√≥n**: Tiempo promedio hasta resoluci√≥n
- **Impacto Econ√≥mico**: Ahorro energ√©tico, prevenci√≥n fraude

### KPIs de Calidad de Datos
- **Cobertura de Perfiles**: % servicios con perfil estad√≠stico
- **Confianza Promedio**: Score promedio de confianza
- **Uso de Fallback**: % casos que requieren fallback
- **Frescura de Datos**: Antig√ºedad promedio de perfiles

### KPIs para IA
- **Accuracy**: Precisi√≥n de clasificaci√≥n
- **Recall**: Cobertura de detecci√≥n
- **F1-Score**: Balance precisi√≥n-cobertura
- **AUC-ROC**: Capacidad discriminativa

## üîÑ Flujo de Procesamiento

### 1. **Ingesta de Datos**
```mermaid
graph TD
    A[Lectura Shelly] --> B[Almacenamiento Raw]
    B --> C[Procesamiento Tiempo Real]
    C --> D[C√°lculo Perfiles]
    D --> E[Detecci√≥n Anomal√≠as]
```

### 2. **An√°lisis Inteligente**
```mermaid
graph TD
    A[Anomal√≠a Detectada] --> B[An√°lisis Contextual]
    B --> C[Evaluaci√≥n Patrones]
    C --> D[Generaci√≥n Recomendaciones]
    D --> E[Metadatos IA]
```

### 3. **Ciclo de Mejora**
```mermaid
graph TD
    A[Recomendaci√≥n] --> B[Acci√≥n Usuario]
    B --> C[Seguimiento Resultado]
    C --> D[Feedback IA]
    D --> E[Mejora Modelo]
    E --> A
```

## üõ†Ô∏è Implementaci√≥n T√©cnica

### Archivos Principales
- `lib/energy/calculate-expected-energy.ts` - Motor de c√°lculo
- `app/api/internal/energy-insights/route.ts` - API principal
- `lib/energy/usage-finalizer.ts` - Finalizaci√≥n de perfiles
- `prisma/seed-anomalias.ts` - Datos de prueba

### Configuraci√≥n
```typescript
const ENERGY_INSIGHT_CONFIG = {
  minSamples: 5,
  deviationThreshold: 0.2,
  sigmaMultiplier: 2,
  confidenceThresholds: {
    high: 0.8,
    medium: 0.5,
    low: 0.2
  }
}
```

### Base de Datos
```sql
-- Perfiles estad√≠sticos
CREATE TABLE smart_plug_service_energy_profiles (
  id TEXT PRIMARY KEY,
  system_id TEXT NOT NULL,
  equipment_id TEXT NOT NULL,
  service_id TEXT NOT NULL,
  avg_kwh_per_min REAL NOT NULL,
  std_dev_kwh_per_min REAL NOT NULL,
  sample_count INTEGER NOT NULL,
  -- Campos para algoritmo de Welford
  m2_kwh_per_min REAL DEFAULT 0,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- Anomal√≠as detectadas
CREATE TABLE smart_plug_device_usage_insights (
  id TEXT PRIMARY KEY,
  system_id TEXT NOT NULL,
  clinic_id TEXT NOT NULL,
  appointment_id TEXT NOT NULL,
  insight_type TEXT NOT NULL,
  actual_kwh REAL NOT NULL,
  expected_kwh REAL NOT NULL,
  deviation_pct REAL NOT NULL,
  detail_json JSONB, -- Metadatos para IA
  resolved BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT NOW()
);
```

## üéØ Roadmap de Integraci√≥n IA

### Fase 1: Preparaci√≥n (Actual)
- ‚úÖ Estructura de datos para ML
- ‚úÖ Metadatos de calidad
- ‚úÖ Sistema de recomendaciones
- ‚úÖ Documentaci√≥n completa

### Fase 2: Recolecci√≥n de Datos (Pr√≥xima)
- üìä Acumulaci√≥n de datasets
- üìà Validaci√≥n de patrones
- üîç Refinamiento de features
- üìã Etiquetado de resultados

### Fase 3: Modelo Base (Futura)
- ü§ñ Clasificador de anomal√≠as
- üìä Predictor de severidad
- üéØ Recomendador inteligente
- üìà Evaluaci√≥n de rendimiento

### Fase 4: Optimizaci√≥n (Avanzada)
- üß† Aprendizaje continuo
- üîÑ Feedback loops
- üìä A/B testing
- üéØ Personalizaci√≥n

## üìö Referencias y Recursos

### Documentaci√≥n T√©cnica
- [Algoritmo de Welford](https://en.wikipedia.org/wiki/Algorithms_for_calculating_variance#Welford's_online_algorithm)
- [Detecci√≥n de Anomal√≠as](https://en.wikipedia.org/wiki/Anomaly_detection)
- [Sistemas de Recomendaci√≥n](https://en.wikipedia.org/wiki/Recommender_system)

### Herramientas ML Sugeridas
- **TensorFlow.js**: Para modelos en el navegador
- **scikit-learn**: Para prototipado r√°pido
- **PyTorch**: Para modelos avanzados
- **MLflow**: Para gesti√≥n de experimentos

### Datasets de Referencia
- Perfiles energ√©ticos por servicio
- Patrones de comportamiento de usuarios
- Resultados de recomendaciones
- M√©tricas de satisfacci√≥n

---

**√öltima actualizaci√≥n**: 2024-12-28
**Versi√≥n**: 1.0.0
**Mantenedor**: Sistema Energy Insights 