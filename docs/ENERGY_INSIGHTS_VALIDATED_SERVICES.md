# üéØ ENERGY INSIGHTS - NUEVA ARQUITECTURA BASADA EN SERVICIOS VALIDATED

## üìã Resumen Ejecutivo

Este documento describe la **refactorizaci√≥n completa** del sistema Energy Insights, migrando de una arquitectura basada en `deviceData.servicesDetails` a una nueva arquitectura que procesa **√∫nicamente servicios VALIDATED** con l√≥gica avanzada de duraci√≥n de tratamiento.

### üéØ Objetivos Cumplidos

1. ‚úÖ **Procesar SOLO servicios VALIDATED** en lugar de todos los planificados
2. ‚úÖ **Implementar l√≥gica treatmentDurationMinutes vs durationMinutes** 
3. ‚úÖ **Leer directamente de ServiceEnergyProfile** para an√°lisis
4. ‚úÖ **Eliminar dependencia de datos desagregados** legacy
5. ‚úÖ **Mantener coherencia con algoritmo de Welford** existente

---

## üèóÔ∏è Arquitectura del Sistema

### üîÑ Flujo de Datos Refactorizado

```mermaid
graph TD
    A[Appointment Completed] --> B[Usage Finalizer]
    B --> C{Get VALIDATED Services}
    C --> D[Calculate Effective Duration]
    D --> E{treatmentDurationMinutes > 0?}
    E -->|Yes| F[Use treatmentDurationMinutes]
    E -->|No| G{treatmentDurationMinutes = 0?}
    G -->|Yes, durationMinutes > 0| H[Use durationMinutes as fallback]
    G -->|No| I[Exclude from energy stats]
    F --> J[Proportional Energy Allocation]
    H --> J
    J --> K[Update ServiceEnergyProfile - Welford]
    K --> L[Generate Duration Insights]
    
    M[Recalc API] --> N[Read ServiceEnergyProfile directly]
    N --> O[Apply Welford Algorithm]
    O --> P[Update Profiles]
    
    Q[Stats API] --> R[Read ServiceEnergyProfile directly]
    R --> S[Equipment Variability Analysis]
```

### üìä Tablas Principales

#### 1. `appointment_services` (Fuente de Verdad)
```sql
-- Solo servicios con status = 'VALIDATED' se procesan
SELECT * FROM appointment_services 
WHERE appointmentId = ? AND status = 'VALIDATED'
```

#### 2. `smart_plug_service_energy_profiles` (Datos Calculados)
```sql
-- Perfiles energ√©ticos con algoritmo de Welford
-- Lectura directa para an√°lisis y estad√≠sticas
SELECT 
  equipmentId,
  serviceId,
  avgKwhPerMin,      -- Media de consumo (Welford)
  stdDevKwhPerMin,   -- Desviaci√≥n est√°ndar consumo (Welford)
  avgMinutes,        -- Media duraci√≥n real (Welford)
  stdDevMinutes,     -- Desviaci√≥n est√°ndar duraci√≥n (Welford)
  sampleCount,       -- N√∫mero de muestras
  m2KwhPerMin,       -- Suma cuadrados energ√≠a (Welford)
  m2Minutes          -- Suma cuadrados duraci√≥n (Welford)
FROM smart_plug_service_energy_profiles
```

#### 3. `appointment_service_energy_usage` (Datos Desagregados)
```sql
-- Solo para trazabilidad, NO para an√°lisis principal
-- El an√°lisis lee directamente de ServiceEnergyProfile
```

---

## üîß Componentes Refactorizados

### 1. Usage Finalizer (`lib/energy/usage-finalizer.ts`)

#### üéØ Cambios Cr√≠ticos Implementados

```typescript
// ‚ùå ANTES: Usaba deviceData.servicesDetails (servicios planificados)
const services = deviceData?.servicesDetails ?? []

// ‚úÖ AHORA: Obtiene servicios VALIDATED de la tabla
const validatedServices = await prisma.appointmentService.findMany({
  where: {
    appointmentId: usage.appointmentId,
    status: 'VALIDATED'  // üî• CR√çTICO: Solo VALIDATED
  }
})
```

#### üßÆ L√≥gica de Duraci√≥n Efectiva

```typescript
// üî• L√ìGICA CR√çTICA: treatmentDurationMinutes vs durationMinutes
if (service.treatmentDurationMinutes && service.treatmentDurationMinutes > 0) {
  // PRIORIDAD 1: Duraci√≥n espec√≠fica para dispositivos
  effectiveDuration = service.treatmentDurationMinutes
  durationSource = 'treatmentDurationMinutes'
  shouldIncludeInStats = true
}
else if (service.treatmentDurationMinutes === 0 && service.durationMinutes > 0) {
  // PRIORIDAD 2: Fallback solo si treatment = 0
  effectiveDuration = service.durationMinutes
  durationSource = 'durationMinutes_fallback'
  shouldIncludeInStats = true
}
else {
  // CASO CR√çTICO: Si treatmentDurationMinutes = 0, NO generar datos
  shouldIncludeInStats = false
}
```

#### üìä Variables Cr√≠ticas

| Variable | Descripci√≥n | Origen |
|----------|-------------|---------|
| `validatedServices` | Solo servicios VALIDATED | `appointment_services.status = 'VALIDATED'` |
| `effectiveDuration` | Duraci√≥n real para c√°lculos | `treatmentDurationMinutes` o `durationMinutes` |
| `shouldIncludeInStats` | Si generar datos energ√©ticos | L√≥gica de validaci√≥n de duraci√≥n |
| `realMinutes` | Tiempo real proporcional | `usage.actualMinutes * ratio` |
| `allocatedKwh` | Energ√≠a proporcional | `usage.energyConsumption * ratio` |

### 2. Recalc API (`app/api/internal/energy-insights/recalc/route.ts`)

#### üéØ Nueva Arquitectura

```typescript
// ‚úÖ NUEVA L√ìGICA: Obtiene datos desde appointment_device_usage + services VALIDATED
const deviceUsages = await prisma.appointmentDeviceUsage.findMany({
  include: {
    appointment: {
      include: {
        services: {
          where: { status: 'VALIDATED' },  // üî• FILTRO CR√çTICO
          include: { service: true }
        }
      }
    }
  }
})
```

#### üìä Algoritmo de Welford Completo

```typescript
// üìä APLICAR ALGORITMO DE WELFORD PARA REC√ÅLCULO COMPLETO
for (const data of serviceDataArray) {
  sampleCount++
  const kwhPerMin = data.allocatedKwh / data.realMinutes

  // Welford para kWh/min
  const deltaKwh = kwhPerMin - avgKwhPerMin
  avgKwhPerMin = avgKwhPerMin + deltaKwh / sampleCount
  const delta2Kwh = kwhPerMin - avgKwhPerMin
  m2KwhPerMin = m2KwhPerMin + deltaKwh * delta2Kwh

  // Welford para minutos
  const deltaMin = data.realMinutes - avgMinutes
  avgMinutes = avgMinutes + deltaMin / sampleCount
  const delta2Min = data.realMinutes - avgMinutes
  m2Minutes = m2Minutes + deltaMin * delta2Min
}
```

### 3. Stats API (`app/api/internal/energy-insights/stats/route.ts`)

#### üéØ Lectura Directa de Perfiles

```typescript
// ‚úÖ NUEVA ARQUITECTURA: Lee directamente de ServiceEnergyProfile
const equipmentVariability = await prisma.serviceEnergyProfile.findMany({
  where: {
    systemId,
    sampleCount: { gte: 5 },
    stdDevKwhPerMin: { gt: 0 }
  },
  include: {
    equipment: { select: { id: true, name: true } },
    service: { 
      select: { 
        id: true, name: true, 
        durationMinutes: true, 
        treatmentDurationMinutes: true 
      } 
    }
  }
})
```

#### üìà M√©tricas Avanzadas

```typescript
// üßÆ CALCULAR M√âTRICAS DE VARIABILIDAD
const variabilityPct = profile.avgKwhPerMin > 0 ? 
  Math.round((profile.stdDevKwhPerMin / profile.avgKwhPerMin) * 100) : 0

const durationVariabilityPct = profile.avgMinutes > 0 && profile.stdDevMinutes > 0 ? 
  Math.round((profile.stdDevMinutes / profile.avgMinutes) * 100) : 0

// üéØ DURACI√ìN CONFIGURADA CON NUEVA L√ìGICA
const configuredDurationMinutes = profile.service?.treatmentDurationMinutes || 
                                 profile.service?.durationMinutes || null

// üìà EFICIENCIA DE DURACI√ìN
const durationEfficiencyPct = configuredDurationMinutes && profile.avgMinutes > 0 ?
  Math.round((configuredDurationMinutes / profile.avgMinutes) * 100) : null
```

---

## üö® Validaciones Cr√≠ticas

### 1. Servicios VALIDATED √önicamente

```typescript
// ‚úÖ CORRECTO: Solo servicios validados por el profesional
const validatedServices = await prisma.appointmentService.findMany({
  where: { 
    appointmentId: usage.appointmentId,
    status: 'VALIDATED'  // Servicios realmente ejecutados
  }
})

// ‚ùå INCORRECTO: Todos los servicios planificados
const allServices = await prisma.appointmentService.findMany({
  where: { appointmentId: usage.appointmentId }
})
```

### 2. L√≥gica treatmentDurationMinutes

```typescript
// ‚úÖ CORRECTO: Validaci√≥n exhaustiva
if (service.treatmentDurationMinutes && service.treatmentDurationMinutes > 0) {
  // Usar duraci√≥n espec√≠fica para dispositivos
  effectiveDuration = service.treatmentDurationMinutes
} else if (service.treatmentDurationMinutes === 0 && service.durationMinutes > 0) {
  // Fallback solo si treatment = 0 expl√≠citamente
  effectiveDuration = service.durationMinutes
} else {
  // NO generar datos si treatmentDurationMinutes no es v√°lido
  shouldIncludeInStats = false
}

// ‚ùå INCORRECTO: Usar durationMinutes sin validar treatmentDurationMinutes
const duration = service.treatmentDurationMinutes || service.durationMinutes
```

### 3. Lectura Directa de Perfiles

```typescript
// ‚úÖ CORRECTO: Leer directamente de ServiceEnergyProfile
const profiles = await prisma.serviceEnergyProfile.findMany({
  where: { systemId, sampleCount: { gte: 5 } }
})

// ‚ùå INCORRECTO: Usar datos desagregados
const usage = await prisma.appointmentServiceEnergyUsage.findMany({
  where: { systemId }
})
```

---

## üîç Casos de Uso y Escenarios

### Escenario 1: Servicio con treatmentDurationMinutes

```typescript
// Servicio: Depilaci√≥n L√°ser Facial
// durationMinutes: 60 (duraci√≥n total de la cita)
// treatmentDurationMinutes: 15 (tiempo real de uso del l√°ser)

// ‚úÖ RESULTADO: Se usa 15 minutos para c√°lculos energ√©ticos
// ‚úÖ RAZ√ìN: treatmentDurationMinutes > 0 tiene prioridad
```

### Escenario 2: Servicio sin treatmentDurationMinutes

```typescript
// Servicio: Limpieza Facial Manual
// durationMinutes: 45
// treatmentDurationMinutes: 0 (no usa dispositivos energ√©ticos)

// ‚úÖ RESULTADO: Se usa 45 minutos como fallback
// ‚úÖ RAZ√ìN: treatmentDurationMinutes = 0 permite fallback
```

### Escenario 3: Servicio sin duraci√≥n v√°lida

```typescript
// Servicio: Consulta
// durationMinutes: 0
// treatmentDurationMinutes: null

// ‚úÖ RESULTADO: Se excluye de estad√≠sticas energ√©ticas
// ‚úÖ RAZ√ìN: No hay duraci√≥n v√°lida para c√°lculos
```

### Escenario 4: Servicios No VALIDATED

```typescript
// Servicios planificados: [Depilaci√≥n, Limpieza, Masaje]
// Servicios VALIDATED: [Depilaci√≥n, Limpieza] (Masaje cancelado)

// ‚úÖ RESULTADO: Solo Depilaci√≥n y Limpieza generan datos energ√©ticos
// ‚úÖ RAZ√ìN: Solo servicios VALIDATED se procesan
```

---

## üìä Impacto en An√°lisis y Reportes

### 1. Tabla de Equipamiento (equipmentVariability)

```typescript
// ‚úÖ NUEVA FUENTE: ServiceEnergyProfile (datos ya calculados)
{
  equipmentName: "L√°ser Diodo 808nm",
  serviceName: "Depilaci√≥n Facial",
  avgKwhPerMin: 0.0583,           // Welford
  stdDevKwhPerMin: 0.0089,        // Welford
  variabilityPct: 15,             // Variabilidad energ√©tica
  configuredDurationMinutes: 15,  // treatmentDurationMinutes
  avgRealDurationMinutes: 14.2,   // Welford - duraci√≥n real
  durationVariabilityPct: 8,      // Variabilidad de duraci√≥n
  durationEfficiencyPct: 106,     // Eficiencia (15/14.2*100)
  sampleCount: 47,                // N√∫mero de muestras
  durationSource: "treatmentDurationMinutes"
}
```

### 2. Insights de Duraci√≥n

```typescript
// ‚úÖ NUEVA L√ìGICA: Basada en servicios VALIDATED
{
  insightType: "OVER_DURATION",
  actualMinutes: 18.5,
  estimatedMinutes: 15.0,  // Suma de treatmentDurationMinutes
  deviationPct: 23.3,
  detailJson: {
    servicesProcessed: 1,
    newArchitecture: true,
    durationSources: [{
      serviceName: "Depilaci√≥n Facial",
      durationSource: "treatmentDurationMinutes",
      effectiveDuration: 15
    }]
  }
}
```

---

## üîß Migraci√≥n y Compatibilidad

### Datos Existentes

1. **ServiceEnergyProfile**: ‚úÖ Compatible - Estructura no cambia
2. **AppointmentServiceEnergyUsage**: ‚ö†Ô∏è Legacy - Solo para trazabilidad
3. **DeviceUsageInsight**: ‚úÖ Compatible - Nuevos campos en detailJson

### Proceso de Migraci√≥n

1. **Ejecutar Rec√°lculo**: `POST /api/internal/energy-insights/recalc`
2. **Verificar Perfiles**: Los perfiles se actualizan con nueva l√≥gica
3. **Validar Estad√≠sticas**: La tabla de equipamiento muestra datos correctos
4. **Monitorear Insights**: Nuevos insights incluyen metadatos de arquitectura

---

## üö® Precauciones y Riesgos

### ‚ö†Ô∏è Riesgos Mitigados

1. **Datos Inconsistentes**: Solo servicios VALIDATED garantizan datos reales
2. **Duraciones Incorrectas**: L√≥gica treatmentDurationMinutes vs durationMinutes
3. **Estad√≠sticas Infladas**: Exclusi√≥n de servicios no ejecutados
4. **C√°lculos Err√≥neos**: Validaci√≥n exhaustiva de duraci√≥n > 0

### üîç Monitoreo Requerido

1. **Logs del Finalizer**: Verificar servicios procesados vs excluidos
2. **Estad√≠sticas de Rec√°lculo**: Validar n√∫mero de perfiles actualizados
3. **Insights Generados**: Confirmar l√≥gica de duraci√≥n correcta
4. **Performance**: Monitorear tiempos de respuesta de APIs

---

## üìà M√©tricas de √âxito

### KPIs Implementados

- ‚úÖ **100% servicios VALIDATED**: Solo datos reales procesados
- ‚úÖ **L√≥gica treatmentDurationMinutes**: Prioridad correcta implementada
- ‚úÖ **Lectura directa perfiles**: Eliminada dependencia de datos desagregados
- ‚úÖ **Algoritmo Welford**: Mantenida coherencia estad√≠stica
- ‚úÖ **Documentaci√≥n exhaustiva**: Contexto completo para futuro desarrollo

### Mejoras Cuantificables

- üöÄ **Performance**: Lectura directa de perfiles (vs agregaciones complejas)
- üéØ **Precisi√≥n**: Solo servicios realmente ejecutados
- üîß **Mantenibilidad**: C√≥digo limpio sin legacy
- üìä **An√°lisis**: M√©tricas de duraci√≥n real vs configurada
- ü§ñ **IA Ready**: Metadatos completos para futura integraci√≥n

---

## üîó Referencias

- `lib/energy/usage-finalizer.ts` - Finalizador refactorizado
- `app/api/internal/energy-insights/recalc/route.ts` - API de rec√°lculo
- `app/api/internal/energy-insights/stats/route.ts` - API de estad√≠sticas
- `prisma/schema.prisma` - Esquema de base de datos
- `docs/HYBRID_CONFIDENCE_SYSTEM.md` - Sistema de confianza h√≠brido

---

**Documento actualizado**: {{timestamp}}
**Versi√≥n**: 1.0.0
**Autor**: AI Assistant
**Revisi√≥n**: Energy Insights Team 